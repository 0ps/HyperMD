/*!
 * HyperMD, copyright (c) by laobubu
 * Distributed under an MIT license: http://laobubu.net/HyperMD/LICENSE
 *
 * Break the Wall between writing and preview, in a Markdown Editor.
 *
 * HyperMD makes Markdown editor on web WYSIWYG, based on CodeMirror
 *
 * Homepage: http://laobubu.net/HyperMD/
 * Issues: https://github.com/laobubu/HyperMD/issues
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("codemirror"),require("codemirror/mode/markdown/markdown"),require("codemirror/mode/stex/stex"),require("marked"),require("codemirror/mode/meta")):"function"==typeof define&&define.amd?define(["exports","codemirror","codemirror/mode/markdown/markdown","codemirror/mode/stex/stex","marked","codemirror/mode/meta"],t):t(e.HyperMD={},e.CodeMirror,null,null,e.marked)}(this,function(e,L,t,n,i){"use strict";var S="default"in L?L.default:L;i=i&&i.hasOwnProperty("default")?i.default:i,"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(e,t){var n=arguments;if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(e),r=1;r<arguments.length;r++){var o=n[r];if(null!=o)for(var a in o)Object.prototype.hasOwnProperty.call(o,a)&&(i[a]=o[a])}return i},writable:!0,configurable:!0});var s=function(e,t,n,i){void 0===n&&(n=!1),void 0===i&&(i="enabled"),this.on_cb=e,this.off_cb=t,this.state=n,this.subkey=i};function c(t,n,i){n=~~n||5;var r=250;setTimeout(function e(){if(n--){try{if(t())return}catch(e){}setTimeout(e,r),r*=2}else i&&i()},0)}function r(e,t){var n=null,i=0,r=function(){e(),n=0},o=function(){var e=+new Date;if(n){if(e<i)return;clearTimeout(n)}n=setTimeout(r,t),i=e+100};return o.stop=function(){n&&(clearTimeout(n),n=0)},o}function a(e,t){var n=new Array(t);if(n.fill)n.fill(e);else for(var i=0;i<t;i++)n[i]=e;return n}function u(e,t){for(var n="";0<t--;)n+=e;return n}function o(e,t){if(t>=e.display.viewTo)return null;if((t-=e.display.viewFrom)<0)return null;for(var n=e.display.view,i=0;i<n.length;i++)if((t-=n[i].size)<0)return i}function x(e,t){if(t>=e.display.viewFrom&&t<e.display.viewTo)return e.display.view[o(e,t)];var n=e.display.externalMeasured;return n&&t>=n.lineN&&t<n.lineN+n.size?n:void 0}function w(e,t,n){if(e.line==t)return{map:e.measure.map,cache:e.measure.cache,before:!1};for(var i=0;i<e.rest.length;i++)if(e.rest[i]==t)return{map:e.measure.maps[i],cache:e.measure.caches[i],before:!1};for(var r=0;r<e.rest.length;r++)if(e.rest[r].lineNo()>n)return{map:e.measure.maps[r],cache:e.measure.caches[r],before:!0}}s.prototype.set=function(e,t){var n="object"==typeof e&&e?e[this.subkey]:e;t&&(n=!!n),n!==this.state&&((this.state=n)?this.on_cb(n):this.off_cb(n))},s.prototype.setBool=function(e){return this.set(e,!0)};var l=Object.freeze({findViewIndex:o,findViewForLine:x,mapFromLineView:w}),M=function(e){this.cm=e};function b(e,t,n){var i,r=t.line,o={line:r,ch:0},a={line:r,ch:t.ch},l=new RegExp("(?:^|\\s)"+n+"(?:\\s|$)"),s=e.getLineTokens(r);for(i=0;i<s.length&&!(s[i].end>=t.ch);i++);if(i===s.length)return null;for(var d=i;d<s.length;d++){var c=s[d];if(!l.test(c.type))break;a.ch=c.end}for(d=i;0<=d;d--){c=s[d];if(!l.test(c.type)){o.ch=c.end;break}}return{from:o,to:a}}function d(e,t){if(!t)for(var n=0,i=e.display.view;n<i.length;n+=1){var r=i[n];r.measure&&(r.measure.cache={})}setTimeout(function(){e.display.input.showSelection(e.display.input.prepareSelection())},60)}M.prototype.findNext=function(n,e,i){var r=this.lineNo,o=this.lineTokens,a=null,l=this.i_token+1,t=!1;if(!0===e?t=!0:"number"==typeof e&&(l=e),i)if(i.line>r)l=o.length;else if(i.line<r);else for(;l<o.length&&!(o[l].start>=i.ch);l++);for(;l<o.length;l++){var s=o[l];if("function"==typeof n?n(s):n.test(s.type)){a=s;break}}if(!a&&t){var d=this.cm,c=Math.max(i?i.line:0,r+1);d.eachLine(c,d.lastLine()+1,function(e){if(r=e.lineNo(),o=d.getLineTokens(r),l=0,i&&r===i.line)for(;l<o.length&&!(o[l].start>=i.ch);l++);for(;l<o.length;l++){var t=o[l];if("function"==typeof n?n(t):n.test(t.type))return a=t,!0}})}return a?{lineNo:r,token:a,i_token:l}:null},M.prototype.findPrev=function(e,t,n){var i=this.lineNo,r=this.lineTokens,o=null,a=this.i_token-1,l=!1;if(!0===t?l=!0:"number"==typeof t&&(a=t),n)if(n.line<i)a=-1;else if(n.line>i);else for(;a<r.length&&!(r[a].start>=n.ch);a++);for(a>=r.length&&(a=r.length-1);0<=a;a--){var s=r[a];if("function"==typeof e?e(s):e.test(s.type)){o=s;break}}if(!o&&l){var d=this.cm,c=Math.min(n?n.line:d.lastLine(),i-1),h=d.firstLine();for(i=c+1;!o&&h<=--i;){d.getLineHandle(i);if(r=d.getLineTokens(i),a=0,n&&i===n.line)for(;a<r.length&&!(r[a].start>=n.ch);a++);for(a>=r.length&&(a=r.length-1);0<=a;a--){s=r[a];if("function"==typeof e?e(s):e.test(s.type)){o=s;break}}}}return o?{lineNo:i,token:o,i_token:a}:null},M.prototype.expandRange=function(t,e){var n,i=this.cm;"function"==typeof t?n=t:("string"==typeof t&&(t=new RegExp("(?:^|\\s)"+t+"(?:\\s|$)")),n=function(e){return!!e&&t.test(e.type||"")});for(var r={lineNo:this.lineNo,i_token:this.i_token,token:this.lineTokens[this.i_token]},o=Object.assign({},r),a=!1,l=this.lineTokens,s=this.i_token;!a;){for(s>=l.length&&(s=l.length-1);0<=s;s--){var d=l[s];if(!n(d)){a=!0;break}r.i_token=s,r.token=d}if(a||!(e&&r.lineNo>i.firstLine()))break;s=(l=i.getLineTokens(--r.lineNo)).length-1}for(a=!1,l=this.lineTokens,s=this.i_token;!a;){for(s<0&&(s=0);s<l.length;s++){var c=l[s];if(!n(c)){a=!0;break}o.i_token=s,o.token=c}if(a||!(e&&o.lineNo<i.lastLine()))break;l=i.getLineTokens(++o.lineNo),s=0}return{from:r,to:o}},M.prototype.setPos=function(e,t,n){void 0===t?(t=e,e=this.line):"number"==typeof e&&(e=this.cm.getLineHandle(e));var i=e===this.line,r=0;n||!i?(this.line=e,this.lineNo=e.lineNo(),this.lineTokens=this.cm.getLineTokens(this.lineNo)):(r=this.i_token,this.lineTokens[r].start>t&&(r=0));for(var o=this.lineTokens;r<o.length&&!(o[r].end>t);r++);this.i_token=r};function h(i,r,o){return function(e){if(e.hmd||(e.hmd={}),!e.hmd[i]){var t=new r(e);if(e.hmd[i]=t,o)for(var n in o)t[n]=o[n];return t}return e.hmd[i]}}function f(e,t){var n={};for(var i in t)n[i]=e.hasOwnProperty(i)?e[i]:t[i];return n}var m=Object.freeze({Addon:function(e){},Getter:h,migrateOption:f}),C=/^(?:[*\-+]|^[0-9]+([.)]))\s+/,O=/^((?:(?:aaas?|about|acap|adiumxtra|af[ps]|aim|apt|attachment|aw|beshare|bitcoin|bolo|callto|cap|chrome(?:-extension)?|cid|coap|com-eventbrite-attendee|content|crid|cvs|data|dav|dict|dlna-(?:playcontainer|playsingle)|dns|doi|dtn|dvb|ed2k|facetime|feed|file|finger|fish|ftp|geo|gg|git|gizmoproject|go|gopher|gtalk|h323|hcp|https?|iax|icap|icon|im|imap|info|ipn|ipp|irc[6s]?|iris(?:\.beep|\.lwz|\.xpc|\.xpcs)?|itms|jar|javascript|jms|keyparc|lastfm|ldaps?|magnet|mailto|maps|market|message|mid|mms|ms-help|msnim|msrps?|mtqp|mumble|mupdate|mvn|news|nfs|nih?|nntp|notes|oid|opaquelocktoken|palm|paparazzi|platform|pop|pres|proxy|psyc|query|res(?:ource)?|rmi|rsync|rtmp|rtsp|secondlife|service|session|sftp|sgn|shttp|sieve|sips?|skype|sm[bs]|snmp|soap\.beeps?|soldat|spotify|ssh|steam|svn|tag|teamspeak|tel(?:net)?|tftp|things|thismessage|tip|tn3270|tv|udp|unreal|urn|ut2004|vemmi|ventrilo|view-source|webcal|wss?|wtai|wyciwyg|xcon(?:-userid)?|xfire|xmlrpc\.beeps?|xmpp|xri|ymsgr|z39\.50[rs]?):(?:\/{1,3}|[a-z0-9%])|www\d{0,3}[.]|[a-z0-9.\-]+[.][a-z]{2,4}\/)(?:[^\s()<>]|\([^\s()<>]*\))+(?:\([^\s()<>]*\)|[^\s`*!()\[\]{};:'".,<>?«»“”‘’]))/i,E=/^\.{0,2}\/[^\>\s]+/,R=/^\s*[^|].*?\|.*[^|]\s*$/,A=/^\s*[^\|].*\|/,N=/^(?:\s*\:?\s*\-+\s*\:?\s*\|)+\s*\:?\s*\-+\s*\:?\s*$/,I=/^\s*\|\s.*?\s\|\s.*?\s\|\s*$/,F=/^\s*\|/,j=/^\s*\|(?:\s*\:?\s*---+\s*\:?\s*\|){2,}\s*$/,P={1:"hmd-barelink",2:"hmd-barelink hmd-footref",4:"hmd-footnote line-HyperMD-footnote"};S.defineMode("hypermd",function(M,e){var D={math:!0,table:!0,toc:!0,orgModeMarkup:!0,fencedCodeBlockHighlighting:!0,name:"markdown",highlightFormatting:!0,taskLists:!0,strikethrough:!0,emoji:!0,tokenTypeOverrides:{hr:"line-HyperMD-hr hr",list1:"list-1",list2:"list-2",list3:"list-3",code:"inline-code",gitHubSpice:!1}};Object.assign(D,e),D.name="markdown";var _=S.getMode(M,D),t=Object.assign({},_);function H(e,t){var n=e.pos,i=e.match(t.hmdInnerExitTag,!1),r=t.hmdInnerStyle,o=t.hmdInnerMode.token(e,t.hmdInnerState);if(r&&(o?o+=" "+r:o=r),i){var a=t.hmdInnerExitStyle;a&&(o?o+=" "+a:o=a),e.pos=n+t.hmdInnerExitTag.length,t.hmdInnerExitStyle=null,t.hmdInnerExitTag=null,t.hmdInnerMode=null,t.hmdInnerState=null,t.hmdOverride=null}return o}return t.startState=function(){var e=_.startState();return e.hmdTable=0,e.hmdOverride=null,e.hmdInnerExitTag=null,e.hmdInnerExitStyle=null,e.hmdInnerMode=null,e.hmdLinkType=0,e.hmdNextMaybe=0,e},t.copyState=function(e){for(var t=_.copyState(e),n=0,i=["hmdLinkType","hmdNextMaybe","hmdTable","hmdTableID","hmdTableCol","hmdTableRow","hmdOverride","hmdInnerMode","hmdInnerStyle","hmdInnerExitTag","hmdInnerExitStyle"];n<i.length;n+=1){var r=i[n];t[r]=e[r]}return e.hmdInnerMode&&(t.hmdInnerState=S.copyState(e.hmdInnerMode,e.hmdInnerState)),t},t.blankLine=function(e){var t=_.blankLine(e)||"";return-1===e.code&&(t+=" line-HyperMD-codeblock line-background-HyperMD-codeblock-bg"),e.hmdTable&&(e.hmdTable=0,e.hmdTableID=null),t||null},t.token=function(e,t){if(t.hmdOverride)return t.hmdOverride(e,t);var n,i=!!t.htmlState,r=-1===t.code,o=0===e.start,a=(e.column(),t.indentation,t.linkText),l=!(r||i),s=l&&!(t.code||t.indentedCode||t.linkHref),d="";if(l){if(D.math&&s&&(n=e.match(/^\${1,2}/,!1))){var c=n[0],h=c.length;if(2===h||-1!==e.string.indexOf(c,e.pos+h))return d+=function(e,t,n,i){var r=S.getMode(M,n);if(!r||"null"===r.name){e.pos+=i.length;var o=RegExp("^(?:\\.|[\\"+i.charAt(0)+"]+)+");r={token:function(e,t){return e.match(o)||e.next(),null}}}return t.hmdInnerExitTag=i,t.hmdInnerMode=r,t.hmdOverride=H,r.token(e,t.hmdInnerState=S.startState(r))}(e,t,"stex",c)||"",d+=" formatting formatting-math formatting-math-begin math math-"+h,t.hmdInnerStyle="math",t.hmdInnerExitStyle="formatting formatting-math formatting-math-end math math-"+h,d}if(o&&D.orgModeMarkup&&(n=e.match(/^\#\+(\w+\:?)\s*/)))return e.eol()||(t.hmdOverride=function(e,t){return e.skipToEnd(),t.hmdOverride=null,"string hmd-orgmode-markup"}),"meta formatting-hmd-orgmode-markup hmd-orgmode-markup line-HyperMD-orgmode-markup";if(o&&D.toc&&e.match(/^\[TOC\]\s*$/i))return"meta line-HyperMD-toc hmd-toc"}d+=" "+(_.token(e,t)||"");var f=e.current(),u=!!t.htmlState,m=-1===t.code;if(l=l&&!(u||m),s=s&&l&&!(t.code||t.indentedCode||t.linkHref),u!=i&&(d+=u?" hmd-html-begin":" hmd-html-end"),(r||m)&&(t.localMode&&r||(d=d.replace("inline-code","")),d+=" line-HyperMD-codeblock line-background-HyperMD-codeblock-bg",m!==r&&(m?r||(d+=" line-HyperMD-codeblock-begin"):d+=" line-HyperMD-codeblock-end")),l){var p=t.hmdTable;if(o&&p)(1==p?A:F).test(e.string)?(t.hmdTableCol=0,t.hmdTableRow++):(t.hmdTable=p=0,t.hmdTableID=null);t.header&&(t.prevLine.header?d+=" line-HyperMD-header-line line-HyperMD-header-line-"+t.header:d+=" line-HyperMD-header line-HyperMD-header-"+t.header),t.indentedCode&&(d+=" hmd-indented-code"),t.quote&&e.eol()&&(d+=" line-HyperMD-quote line-HyperMD-quote-"+t.quote);var v=(t.listStack[t.listStack.length-1]||0)+3,g=o&&/^\s+$/.test(f)&&(!1!==t.list||e.indentation()<=v),y=t.list&&/formatting-list/.test(d);if(y||g&&(!1!==t.list||e.match(C,!1))){var b=t.listStack&&t.listStack.length||0;if(g){if(e.match(C,!1))!1===t.list&&b++;else{for(;0<b&&e.pos<t.listStack[b-1];)b--;if(!b)return d.trim()||null;d+=" line-HyperMD-list-line-nobullet line-HyperMD-list-line line-HyperMD-list-line-"+b}d+=" hmd-list-indent hmd-list-indent-"+b}else y&&(d+=" line-HyperMD-list-line line-HyperMD-list-line-"+b)}if(a!==t.linkText&&(a?(t.hmdLinkType in P&&(d+=" "+P[t.hmdLinkType]),4===t.hmdLinkType?t.hmdLinkType=5:t.hmdLinkType=0):(n=e.match(/^([^\]]+)\](\(| ?\[|\:)?/,!1)||["](","","("])[2]?":"===n[2]?t.hmdLinkType=4:t.hmdLinkType=3:"^"===n[1].charAt(0)?t.hmdLinkType=2:t.hmdLinkType=1),0!==t.hmdLinkType&&(t.hmdLinkType in P&&(d+=" "+P[t.hmdLinkType]),5===t.hmdLinkType&&(/^(?:\]\:)?\s*$/.test(f)||(O.test(f)||E.test(f)?d+=" hmd-footnote-url":d=d.replace("string url",""),t.hmdLinkType=0))),/formatting-escape/.test(d)&&1<f.length){var k=f.length-1,T=d.replace("formatting-escape","escape")+" hmd-escape-char";return t.hmdOverride=function(e,t){return e.pos+=k,t.hmdOverride=null,T.trim()},d+=" hmd-escape-backslash",e.pos-=k,d}if(!d.trim()&&D.table){var x=!1;if("|"===f.charAt(0)?(e.pos=e.start+1,x=!0):(n=f.match(/\|/))&&(e.pos=e.start+n.index),x&&(p||(R.test(e.string)&&N.test(e.lookAhead(1))?p=1:I.test(e.string)&&j.test(e.lookAhead(1))&&(p=2),(t.hmdTable=p)&&(t.hmdTableID="T"+e.lineOracle.line,t.hmdTableRow=t.hmdTableCol=0)),p)){var w=t.hmdTableRow,L=t.hmdTableCol++;0==L&&(d+=" line-HyperMD-table_"+t.hmdTableID+" line-HyperMD-table-"+p+" line-HyperMD-table-row line-HyperMD-table-row-"+w),d+=" hmd-table-sep hmd-table-sep-"+L,2!==p||0!=L&&!e.match(/^\s*$/,!1)||(d+=" hmd-table-sep-dummy")}}p&&1===t.hmdTableRow&&/emoji/.test(d)&&(d="")}return d.trim()||null},t},"hypermd"),S.defineMIME("text/x-hypermd","hypermd");function p(e,t,n,i){var r=new XMLHttpRequest,o=new FormData;for(var a in t)o.append(a,t[a]);r.onreadystatechange=function(){if(4==this.readyState){var e=r.responseText;try{e=JSON.parse(r.responseText)}catch(e){}/^20\d/.test(r.status+"")?n(e,null):n(null,e)}},r.open(i||"POST",e,!0),r.send(o)}var v=function(e,r){var o=0,t=document.createElement("div");t.className="HyperMD-insertFile-dfh-placeholder",r.setPlaceholder(t);for(var a=[],l="undefined"!=typeof URL,n=0;n<e.length;n++){var i=e[n];if(/image\//.test(i.type)){var s=l?URL.createObjectURL(i):"",d=i.name.match(/[^\\\/]+\.\w+$/)[0],c=document.createElement("img");c.onload=r.resize,c.className="HyperMD-insertFile-dfh-uploading",c.src=s,t.appendChild(c),a.push({blobURL:s,name:d,url:null,placeholder:c}),o++,h(i,a.length-1)}}return 0<o;function h(e,i){p("https://sm.ms/api/upload",{smfile:e,format:"json"},function(e,t){var n=e&&"success"==e.code?e.data.url:null;!function(e,t){a[e].url=t;var n=a[e].placeholder;if(n.className="HyperMD-insertFile-dfh-uploaded",n.src=t||"",l&&URL.revokeObjectURL(a[e].blobURL),0==--o){var i=a.map(function(e){return"!["+e.name+"]("+e.url+")"});r.finish(i.join(" ")+" ")}}(i,n)})}},g={byDrop:!0,byPaste:!0,fileHandler:v},y=function(e){var o=this;this.byPaste=g.byPaste,this.byDrop=g.byDrop,this.fileHandler=g.fileHandler,this.pasteHandle=function(e,t){o.doInsert(t.clipboardData||window.clipboardData)&&t.preventDefault()},this.dropHandle=function(t,n){var i=o,r=(t=o.cm,!1);t.operation(function(){var e=t.coordsChar({left:n.clientX,top:n.clientY});t.setCursor(e),r=i.doInsert(n.dataTransfer)}),r&&n.preventDefault()},this.ff_paste=new s(function(){return o.cm.on("paste",o.pasteHandle)},function(){return o.cm.off("paste",o.pasteHandle)}),this.ff_drop=new s(function(){return o.cm.on("drop",o.pasteHandle)},function(){return o.cm.off("drop",o.pasteHandle)}),this.cm=e};y.prototype.doInsert=function(e){var a=this.cm;if(!e||!e.files||0===e.files.length)return!1;var l=e.files,s="function"==typeof this.fileHandler?[this.fileHandler]:this.fileHandler,d=!1;return a.operation(function(){a.replaceSelection(".");for(var e=a.getCursor(),t={line:e.line,ch:e.ch-1},n=document.createElement("span"),o=a.markText(t,e,{replacedWith:n,clearOnEnter:!1,handleMouseEvents:!1}),i={marker:o,cm:a,finish:function(i,r){return a.operation(function(){var e=o.find(),t=e.from,n=e.to;a.replaceRange(i,t,n),o.clear(),"number"==typeof r&&a.setCursor({line:t.line,ch:t.ch+r})})},setPlaceholder:function(e){0<n.childNodes.length&&n.removeChild(n.firstChild),n.appendChild(e),o.changed()},resize:function(){o.changed()}},r=0;r<s.length;r++){if((0,s[r])(l,i)){d=!0;break}}d||o.clear()}),d};var k=h("insertFile",y);S.defineOption("hmdInsertFile",!1,function(e,t){var n=!!t;if(n&&!0!==t){if("function"==typeof t||t instanceof Array)t={byDrop:n,byPaste:n,fileHandler:t};else if("object"!=typeof t)throw new Error("[HyperMD] wrong hmdInsertFile option value")}else t={byDrop:n,byPaste:n};var i=f(t,g),r=k(e);for(var o in r.ff_paste.setBool(i.byPaste),r.ff_drop.setBool(i.byDrop),g)r[o]=i[o]});var T=Object.freeze({ajaxUpload:p,DefaultFileHandler:v,InsertFile:y,defaultOption:g,getAddon:k}),D=function(e){var t=this;this.cm=e,this.cache={},e.on("changes",r(function(){return t.rescan()},500)),this.rescan()};D.prototype.read=function(e,t){var n,i=this.cache[e.trim().toLowerCase()]||[];"number"!=typeof t&&(t=1e9);for(var r=0;r<i.length&&!((n=i[r]).line>t);r++);return n},D.prototype.rescan=function(){var e=this.cm,o=this.cache={};e.eachLine(function(e){var t=e.text,n=/^(?:>\s+)*>?\s{0,3}\[([^\]]+)\]:\s*(.+)$/.exec(t);if(n){var i=n[1].trim().toLowerCase(),r=n[2];o[i]||(o[i]=[]),o[i].push({line:e.lineNo(),content:r})}})};var _=h("readLink",D);function H(e){var t=e=e.trim(),n="",i=e.match(/^(\S+)\s+("(?:[^"\\]+|\\.)+"|[^"\s].*)/);return i&&(t=i[1],'"'===(n=i[2]).charAt(0)&&(n=n.substr(1,n.length-2).replace(/\\"/g,'"'))),{url:t,title:n}}S.defineExtension("hmdReadLink",function(e,t){return _(this).read(e,t)}),S.defineExtension("hmdSplitLink",H);var $=Object.freeze({ReadLink:D,getAddon:_,splitLink:H});function z(e){return"function"==typeof i?i(e):"<pre>"+e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/  /g," &nbsp;")+"</pre>"}var q={enabled:!1,xOffset:10};S.defineOption("hmdHover",!1,function(e,t){var n=!!t;n&&"boolean"!=typeof t||(t={enabled:n});var i=f(t,q),r=U(e);for(var o in r.ff_enable.setBool(i.enabled),q)r[o]=i[o]});var B=function(e){var t=this,n=(this.cm=e).display.lineDiv;this.lineDiv=n;var i=document.createElement("div"),r=document.createElement("div"),o=document.createElement("div");i.setAttribute("style","position:absolute;z-index:99"),i.setAttribute("class","HyperMD-hover"),i.setAttribute("cm-ignore-events","true"),r.setAttribute("class","HyperMD-hover-content"),i.appendChild(r),o.setAttribute("class","HyperMD-hover-indicator"),i.appendChild(o),this.tooltipDiv=i,this.tooltipContentDiv=r,this.tooltipIndicator=o;var a=this.mouseenter.bind(this);this.ff_enable=new s(function(){n.addEventListener("mouseenter",a,!0)},function(){n.removeEventListener("mouseenter",a,!0),t.hideInfo()})};B.prototype.mouseenter=function(e){var t,n=this.cm,i=e.target,r=i.className;if(!(i==this.tooltipDiv||i.compareDocumentPosition&&8==(8&i.compareDocumentPosition(this.tooltipDiv))))if("SPAN"===i.nodeName&&(t=r.match(/(?:^|\s)cm-(hmd-barelink|hmd-link-url-s)(?:\s|$)/))){var o=n.coordsChar({left:e.clientX,top:e.clientY}),a=null,l=b(n,o,t[1]);if(l){var s=n.getRange(l.from,l.to);(s=s.slice(1,-1))&&(a=n.hmdReadLink(s,o.line))}a?this.showInfo(z(a.content),i):this.hideInfo()}else this.hideInfo()},B.prototype.showInfo=function(e,t){var n=t.getBoundingClientRect(),i=this.lineDiv.getBoundingClientRect(),r=this.tooltipDiv,o=this.xOffset;this.tooltipContentDiv.innerHTML=e,r.style.left=n.left-i.left-o+"px",this.lineDiv.appendChild(r);var a=r.getBoundingClientRect();a.right>i.right&&(o=a.right-i.right,r.style.left=n.left-i.left-o+"px"),r.style.top=n.top-i.top-a.height+"px",this.tooltipIndicator.style.marginLeft=o+"px"},B.prototype.hideInfo=function(){this.tooltipDiv.parentElement==this.lineDiv&&this.lineDiv.removeChild(this.tooltipDiv)};var K,U=h("hover",B,q),X=Object.freeze({text2html:z,defaultOption:q,Hover:B,getAddon:U}),J=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,Y=function(e,t){var n=e.text,i=e.type,r=e.url,o=e.pos;if("url"===i||"link"===i){var a=n.match(/\[[^\[\]]+\](?:\[\])?$/);a&&e.altKey?("[]"===(n=a[0]).slice(-2)&&(n=n.slice(0,-2)),i="footref"):(e.ctrlKey||e.altKey)&&r&&window.open(r,"_blank")}if("todo"===i){var l=b(t,o,"formatting-task"),s=l.from,d=l.to,c=t.getRange(s,d);c="[ ]"===c?"[x]":"[ ]",t.replaceRange(c,s,d)}if("footref"===i){var h=n.slice(1,-1),f=t.hmdReadLink(h,o.line);f&&(G(t,f.line,o),t.setCursor({line:f.line,ch:0}))}},G=(K=null,function(e,t,n){var i,r,o=function(e){if(-1==e.options.gutters.indexOf("HyperMD-goback"))return null;var t=document.createElement("div");t.className="HyperMD-goback-button",t.addEventListener("click",function(){e.setCursor(K.find()),e.clearGutter("HyperMD-goback"),K.clear(),K=null});var n=e.display.gutters.children;return n=(n=n[n.length-1]).offsetLeft+n.offsetWidth,t.style.width=n+"px",t.style.marginLeft=-n+"px",t}(e);o&&(o.innerHTML=n.line+1+"",i=e,r=n,K&&(i.clearGutter("HyperMD-goback"),K.clear()),K=i.setBookmark(r),e.setGutterMarker(t,"HyperMD-goback",o))}),W={enabled:!1,handler:null};S.defineOption("hmdClick",!1,function(e,t){var n=!!t;n&&"boolean"!=typeof t?"function"==typeof t&&(t={enabled:!0,handler:t}):t={enabled:n};var i=f(t,W),r=Z(e);for(var o in r.ff_enable.setBool(i.enabled),W)r[o]=i[o]});var Q,V=function(e){var y=this;this.cm=e,this._mouseUp=function(e){var t=y._cinfo;y.lineDiv.removeEventListener("mouseup",y._mouseUp,!1),5<Math.abs(e.clientX-t.clientX)||5<Math.abs(e.clientY-t.clientY)||"function"==typeof y.handler&&!1===y.handler(t,y.cm)||Y(t,y.cm)},this._mouseDown=function(e){var t=e.button,n=e.clientX,i=e.clientY,r=e.ctrlKey,o=e.altKey,a=e.shiftKey,l=y.cm;if("PRE"!==e.target.tagName){var s,d,c,h,f=l.coordsChar({left:n,top:i}),u=" "+l.getTokenTypeAt(f)+" ",m=null;if(d=u.match(/\s(image|link|url)\s/)){s=b(l,f,m=d[1]);var p=/\shmd-barelink\s/.test(u);if(/^(?:image|link)$/.test(m)&&!p){var v=b(l,{line:f.line,ch:s.to.ch+1},"url");v&&(s.to=v.to)}if(d=(c=l.getRange(s.from,s.to).trim()).match(/[^\\]\]\((.+)\)$/))h=H(d[1]).url;else if((d=c.match(/[^\\]\]\[(.+)\]$/))||(d=c.match(/^\[(.+)\]\[\]$/))||(d=c.match(/^\[(.+)\](?:\:\s*)?$/))){p&&"^"===d[1].charAt(0)&&(m="footref");var g=l.hmdReadLink(d[1],f.line);h=g?H(g.content).url:null}else((d=c.match(/^\<(.+)\>$/))||(d=c.match(/^\((.+)\)$/))||(d=[null,c]))&&(h=d[1]);h&&J.test(h)&&(h="mailto:"+h)}else u.match(/\sformatting-task\s/)&&(m="todo",(s=b(l,f,"formatting-task")).to.ch=l.getLine(f.line).length,c=l.getRange(s.from,s.to),h=null);null!==m&&(y._cinfo={type:m,text:c,url:h,pos:f,button:t,clientX:n,clientY:i,ctrlKey:r,altKey:o,shiftKey:a},y.lineDiv.addEventListener("mouseup",y._mouseUp,!1))}},this.lineDiv=e.display.lineDiv,this.ff_enable=new s(function(){y.lineDiv.addEventListener("mousedown",y._mouseDown,!1)},function(){y.lineDiv.removeEventListener("mousedown",y._mouseDown,!1)})},Z=h("click",V,W),ee=Object.freeze({defaultClickHandler:Y,defaultOption:W,Click:V,getAddon:Z}),te=(Q=null,function(){return Q||"function"!=typeof TurndownService||(Q=new TurndownService({headingStyle:"atx",hr:"---",bulletListMarker:"*",codeBlockStyle:"fenced",fence:"```",emDelimiter:"*",strongDelimiter:"**",linkStyle:"inlined",linkReferenceStyle:"collapsed"}),"undefined"!=typeof turndownPluginGfm&&Q.use(turndownPluginGfm.gfm)),Q}),ne=function(e){if(e=e.replace(/<a([^>]*)>(.*?)<\/a>/gi,function(e,t,n){return/href=/i.test(t)?e:n}),!/\<(?:(?:hr|img)|\/(?:h\d|strong|em|strikethrough|a|b|i|del)\>)/i.test(e))return null;var t=te();return t?t.turndown(e):null};S.defineOption("hmdPaste",!1,function(e,t){var n=!!t;n&&"boolean"!=typeof t||(t=ne);var i=re(e);i.ff_enable.setBool(n),i.convertor=t});var ie=function(e){var o=this;this.cm=e,this.convertor=ne,this.pasteHandler=function(e,t){var n=t.clipboardData||window.clipboardData,i=o.convertor;if(i&&n&&-1!=n.types.indexOf("text/html")){var r=i(n.getData("text/html"));r&&(e.operation(e.replaceSelection.bind(e,r)),t.preventDefault())}},this.ff_enable=new s(function(){e.on("paste",o.pasteHandler)},function(){e.off("paste",o.pasteHandler)})},re=h("paste",ie),oe=Object.freeze({defaultConvertor:ne,Paste:ie,getAddon:re}),ae={image:function(e,t){var n=e.cm,i=/\bformatting-link-string\b/;if(/\bimage-marker\b/.test(t.type)&&"!"===t.string){var r=e.lineNo,o=e.findNext(i),a=e.findNext(i,o.i_token+1),l={line:r,ch:t.start},s={line:r,ch:a.token.end},d=e.requestRange(l,s);if(d===se.OK){var c,h,f=n.getRange({line:r,ch:o.token.start+1},{line:r,ch:a.token.start});if("]"===a.token.string){var u=n.hmdReadLink(f,r);if(!u)return null;f=u.content}c=H(f).url,h=n.getRange({line:r,ch:l.ch+2},{line:r,ch:o.token.start-1});var m=document.createElement("img"),p=n.markText(l,s,{collapsed:!0,replacedWith:m});return m.addEventListener("load",function(){m.classList.remove("hmd-image-loading"),p.changed()},!1),m.addEventListener("error",function(){m.classList.remove("hmd-image-loading"),m.classList.add("hmd-image-error"),p.changed()},!1),m.addEventListener("click",function(){return le(n,p)},!1),m.className="hmd-image hmd-image-loading",m.src=c,m.title=h,p}}return null},link:function(e,t){var n=e.cm,i=/\bformatting-link-string\b/;if("("===t.string&&i.test(t.type)&&(0===e.i_token||!/\bimage/.test(e.lineTokens[e.i_token-1].type))){var r=e.lineNo,o=e.findNext(function(e){return i.test(e.type)&&")"===e.string}),a={line:r,ch:t.start},l={line:r,ch:o.token.end},s=e.requestRange(a,l);if(s===se.OK){var d=n.getRange(a,l),c=H(d.substr(1,d.length-2)),h=c.url,f=c.title,u=document.createElement("span");u.setAttribute("class","hmd-link-icon"),u.setAttribute("title",h+"\n"+f),u.setAttribute("data-url",h);var m=n.markText(a,l,{collapsed:!0,replacedWith:u});return u.addEventListener("click",function(){return le(n,m)},!1),m}}return null}};function le(t,n,i){t.operation(function(){var e=n.find().from;e={line:e.line,ch:e.ch+~~i},t.setCursor(e),t.focus(),n.clear()})}var se,de,ce={image:!1,link:!1,customFolders:{}};S.defineOption("hmdFold",!1,function(e,t){var n=!!t;if(!n||"boolean"==typeof t)for(var i in t={},ae)t[i]=n;f(t,ce);var r=fe(e);for(var o in ae)r.setBuiltinStatus(o,t[o]);"object"!=typeof t.customFolders&&(t.customFolders={});var a=[];for(var l in t.customFolders)t.customFolders.hasOwnProperty(l)&&(a.push(l),l in r.folded||(r.folded[l]=[]));r.customFolderTypes=a,r.startFold()}),(de=se||(se={})).OK="ok",de.CURSOR_INSIDE="ci",de.HAS_MARKERS="hm";var he=function(t){function e(e){var n=this;t.call(this,e),this.cm=e,this.ff_builtin={},this.folded={},this.startFold=r(this.startFoldImmediately.bind(this),100),this._quickFoldHint=[],e.on("changes",function(e,t){t.reduce(function(e,t){return Math.min(e,t.from.line)},e.lastLine());n.startFold()}),e.on("cursorActivity",function(e){n.startQuickFold()})}return t&&(e.__proto__=t),((e.prototype=Object.create(t&&t.prototype)).constructor=e).prototype.setBuiltinStatus=function(e,t){if(e in ae){var n=this.ff_builtin[e];n||(n=new s(this.startFold,this.clear.bind(this,e)),this.ff_builtin[e]=n),n.setBool(t)}},e.prototype.requestRange=function(e,t){var n=this.cm,i=S.cmpPos,r=n.getCursor(),o=n.findMarks(e,t),a=se.OK;return 0!==o.length?a=se.HAS_MARKERS:0<=i(r,e)&&i(r,t)<=0&&(a=se.CURSOR_INSIDE),a!==se.OK&&this._quickFoldHint.push(e.line),a},e.prototype.startFoldImmediately=function(e,t){var b=this,n=this.cm;e=e||n.firstLine(),t=(t||n.lastLine())+1,this._quickFoldHint=[],this.setPos(e,0,!0),n.eachLine(e,t,function(e){var t=e.lineNo();if(!(t<b.lineNo)){t>b.lineNo&&b.setPos(t,0);var n=new Array(e.text.length),i=e.markedSpans;if(i)for(var r=0;r<i.length;++r)for(var o=i[r],a=null==o.from?0:o.from,l=null==o.to?n.length:o.to,s=a;s<l;s++)n[s]=!0;for(var d=b.lineTokens;b.i_token<d.length;){for(var c,h=d[b.i_token],f=null,u=!0,m=h.start;m<h.end;m++)if(n[m]){u=!1;break}if(u){for(c in b.ff_builtin)if(b.ff_builtin[c].state&&(f=ae[c](b,h)))break;if(!f)for(var p=0,v=b.customFolderTypes;p<v.length&&(c=v[p],!(f=b.customFolders[c](b,h)));p+=1);}if(f){var g=f.find(),y=(g.from,g.to);if((b.folded[c]||(b.folded[c]=[])).push(f),f.on("clear",function(e,t){var n,i=b.folded[c];i&&-1!==(n=i.indexOf(f))&&i.splice(n,1),b._quickFoldHint.push(e.line)}),y.line!==t)return void b.setPos(y.line,y.ch);b.setPos(y.ch)}else b.i_token++}}})},e.prototype.startQuickFold=function(){var e=this._quickFoldHint;if(0!==e.length){for(var t=e[0],n=t,i=0,r=e;i<r.length;i+=1){var o=r[i];o<t&&(t=o),n<o&&(n=o)}this.startFold.stop(),this.startFoldImmediately(t,n)}},e.prototype.clear=function(e){var t=this.folded[e];if(t&&t.length){for(var n=0,i=t;n<i.length;n+=1){i[n].clear()}t.splice(0)}},e.prototype.clearAll=function(){for(var e in this.folded){for(var t=this.folded[e],n=0,i=t;n<i.length;n+=1){i[n].clear()}t.splice(0)}},e}(M),fe=h("fold",he,ce),ue=Object.freeze({builtinFolder:ae,breakMark:le,defaultOption:ce,get RequestRangeResult(){return se},Fold:he,getAddon:fe}),me=function(e,t){var n=/formatting-math-begin\b/;if(!n.test(t.type))return null;var i=e.cm,r=e.lineNo,o=/math-2\b/.test(t.type),a=o?2:1;if(2==a&&1==t.string.length){0;var l=e.lineTokens[e.i_token+1];if(!l||!n.test(l.type))return null}var s,d=e.findNext(/formatting-math-end\b/,o),c={line:r,ch:t.start};if(d)s={line:d.lineNo,ch:d.token.start+a};else{if(!o)return null;var h=i.lastLine();s={line:h,ch:i.getLine(h).length}}var f={line:c.line,ch:c.ch+a},u={line:s.line,ch:s.ch-a},m=i.getRange(f,u).trim(),p=be(i),v=e.requestRange(c,s);if(v!==se.OK)return v===se.CURSOR_INSIDE&&p.ff_pv.set(m),null;var g=pe(i,c,s,m,a,"math-"+a);return p.ff_pv.set(null),g};function pe(e,t,n,i,r,o){var a=document.createElement("span");a.setAttribute("class","hmd-fold-math "+(o||"")),a.setAttribute("title",i);var l=document.createElement("span");l.setAttribute("class","hmd-fold-math-placeholder"),l.textContent=i,a.appendChild(l);var s=e.markText(t,n,{className:"hmd-fold-math",replacedWith:a,clearOnEnter:!0});a.addEventListener("click",function(){return le(e,s,r)},!1);var d=new(e.hmd.foldMath.renderer||("undefined"==typeof MathJax?ve:ge))(a,"");return d.onChanged=function(){l&&(a.removeChild(l),l=null),s.changed()},s.on("clear",function(){d.clear()}),s.mathRenderer=d,c(function(){return!!d.isReady()&&(d.startRender(i),!0)},5,function(){s.clear()}),s}ae.math=me;var ve=function(e,t){var n=this;this.container=e;var i=document.createElement("img");i.setAttribute("class","hmd-stupid-math"),i.addEventListener("load",function(){n.onChanged&&n.onChanged(n.last_expr)},!1),this.img=i,e.appendChild(i)};ve.prototype.startRender=function(e){this.last_expr=e,this.img.src="https://latex.codecogs.com/gif.latex?"+encodeURIComponent(e)},ve.prototype.clear=function(){this.container.removeChild(this.img)},ve.prototype.isReady=function(){return!0};var ge=function(e,t){this.div=e,this.mode=t,this.onChanged=null,this.jax=null,this._cleared=!1,this._renderingExpr="";var n=document.createElement("script");n.setAttribute("type",t?"math/tex; mode="+t:"math/tex"),e.appendChild(n),this.script=n};ge.prototype.clear=function(){this.script.innerHTML="",this.jax&&this.jax.Remove(),this._cleared=!0},ge.prototype.startRender=function(e){if(!this._cleared)if(this._renderingExpr)this._renderingExpr=e;else{this._renderingExpr=e;var t=this.script;t.innerHTML=e,this.jax?MathJax.Hub.Queue(["Text",this.jax,e],["_TypesetDoneCB",this,e]):(this.jax=MathJax.Hub.getJaxFor(t),MathJax.Hub.Queue(["Typeset",MathJax.Hub,t],["_TypesetDoneCB",this,e]))}},ge.prototype._TypesetDoneCB=function(e){if(!this._cleared){if(this._renderingExpr!==e){var t=this._renderingExpr;return this._renderingExpr="",void this.startRender(t)}this._renderingExpr="","function"==typeof this.onChanged&&this.onChanged(e)}},ge.prototype.isReady=function(){return"object"==typeof MathJax&&MathJax.isReady};var ye={renderer:null,onPreview:null,onPreviewEnd:null};S.defineOption("hmdFoldMath",ye,function(e,t){var n=ye;"object"==typeof t?n=f(t,ye):console.warn("[HyperMD FoldMath] wrong option format. If you want to stop folding math. set options.hmdFold.math = false");var i=be(e);for(var r in n)i[r]=n[r]});var be=h("foldMath",function(e){var t=this;this.cm=e,this.ff_pv=new s(function(e){t.onPreview&&t.onPreview(e)},function(){t.onPreviewEnd&&t.onPreviewEnd()},null)},ye),ke=Object.freeze({MathFolder:me,insertMathMark:pe,StupidRenderer:ve,MathJaxRenderer:ge,defaultOption:ye,getAddon:be}),Te={enabled:!1};S.defineOption("hmdTableAlign",Te,function(e,t){var n=!!t;n&&"boolean"!=typeof t||(t={enabled:n});var i=f(t,Te),r=we(e);for(var o in r.ff_enable.setBool(i.enabled),Te)r[o]=i[o]});var xe=function(e){var h=this;this.cm=e,this.styleEl=document.createElement("style"),this.updateStyle=r(function(){if(h.enabled){var e=h.cm,t=h.measure(),n=h.makeCSS(t);n!==h._lastCSS&&(h.styleEl.textContent=h._lastCSS=n,setTimeout(function(){return d(e)},50))}},100),this._procLine=function(e,t,n){if(n.querySelector(".cm-hmd-table-sep")){for(var i=n.firstElementChild,r=Array.prototype.slice.call(i.childNodes,0),o=0,a=h.makeColumn(o),l=a.firstElementChild,s=0,d=r;s<d.length;s+=1){var c=d[s];c.nodeType===Node.ELEMENT_NODE&&/cm-hmd-table-sep/.test(c.className)?(o++,a.appendChild(l),i.appendChild(a),i.appendChild(c),l=(a=h.makeColumn(o)).firstElementChild):l.appendChild(c)}a.appendChild(l),i.appendChild(a)}},this.ff_enable=new s(function(){e.on("renderLine",h._procLine),e.on("update",h.updateStyle),e.refresh(),document.head.appendChild(h.styleEl)},function(){e.off("renderLine",h._procLine),e.off("update",h.updateStyle),document.head.removeChild(h.styleEl)})};xe.prototype.makeColumn=function(e){var t=document.createElement("span");t.className="hmd-table-column hmd-table-column-"+e,t.setAttribute("data-column",""+e);var n=document.createElement("span");return n.className="hmd-table-column-content",n.setAttribute("data-column",""+e),t.appendChild(n),t},xe.prototype.measure=function(){for(var e=this.cm.display.lineDiv.querySelectorAll(".hmd-table-column-content"),t={},n=0;n<e.length;n++){var i=e[n],r=i.parentElement,o=r.parentElement.parentElement.className.match(/HyperMD-table_(\S+)/)[1],a=~~r.getAttribute("data-column"),l=i.offsetWidth+1;o in t||(t[o]=[]);for(var s=t[o];s.length<=a;)s.push(0);s[a]<l&&(s[a]=l)}return t},xe.prototype.makeCSS=function(e){var t=[];for(var n in e)for(var i=e[n],r="pre.HyperMD-table-row.HyperMD-table_"+n+" .hmd-table-column-",o=0;o<i.length;o++){var a=i[o];t.push(""+r+o+" { min-width: "+a+"px }")}return t.join("\n")};var we=h("tableAlign",xe,Te),Le=Object.freeze({defaultOption:Te,TableAlign:xe,getAddon:we});S.defineOption("hmdLoadModeFrom",!1,function(e,t){var n=!!t,i=De(e);i.ff_enable.setBool(n),i.source=t});var Me=function(e){var l=this;this.cm=e,this.source="./node_modules/codemirror/",this._loadingModes={},this.rlHandler=function(e,t){var n=t.lineNo(),i=(t.text||"").match(/^```\s*(\S+)/);if(i){var r=i[1],o=S.findModeByName(r),a=o&&o.mode;!a||a in S.modes||l.startLoadMode(a,n)}},this.ff_enable=new s(function(){e.on("renderLine",l.rlHandler)},function(){e.off("renderLine",l.rlHandler)})};Me.prototype.touchLine=function(e){var t=this.cm.getLineHandle(e),n=t.text.length;this.cm.replaceRange(t.text.charAt(n-1),{line:e,ch:n-1},{line:e,ch:n})},Me.prototype.startLoadMode=function(e,t){var n=this._loadingModes,i=this;if(0<=t&&e in n)n[e].push(t);else{0<=t&&(n[e]=[t]);var r=function(){console.log("[HyperMD] mode-loader loaded "+e);var t=n[e];i.cm.operation(function(){for(var e=0;e<t.length;e++)i.touchLine(t[e])}),delete n[e]},o=this.source+"mode/"+e+"/"+e+".js";if("function"==typeof requirejs&&"~"===o.charAt(0))requirejs([o.slice(1,-3)],r);else{var a=document.createElement("script");a.onload=r,a.onerror=function(){console.warn("[HyperMD] mode-loader failed to load mode "+e+" from ",o),-1!==t&&(console.log("[HyperMD] mode-loader will retry loading "+e),setTimeout(function(){i.startLoadMode(e,0<=t?-3:t+1)},1e3))},a.src=o,document.head.appendChild(a)}}};var De=h("modeLoader",Me),_e=Object.freeze({ModeLoader:Me,getAddon:De}),He={enabled:!1,line:!0,tokenTypes:"em|strong|strikethrough|code|link|task".split("|")};S.defineOption("hmdHideToken",He,function(e,t){var n=!!t;n&&"boolean"!=typeof t?"string"==typeof t?t={enabled:!0,tokenTypes:t.split("|")}:t instanceof Array&&(t={enabled:!0,tokenTypes:t}):t={enabled:n};var i=f(t,He),r=Ee(e);for(var o in r.ff_enable.setBool(i.enabled),He)r[o]=i[o]});var Se="hmd-hidden-token",Ce="hmd-inactive-line",Oe=function(e){var i=this;this.cm=e,this.shownTokensStart={},this.renderLineHandler=function(e,t,n){i.procLine(t,n)},this.cursorActivityHandler=function(e){i.update()},this.update=r(function(){return i.updateImmediately()},100),this.ff_enable=new s(function(){e.on("cursorActivity",i.cursorActivityHandler),e.on("renderLine",i.renderLineHandler),e.on("update",i.update),i.update()},function(){e.off("cursorActivity",i.cursorActivityHandler),e.off("renderLine",i.renderLineHandler),e.off("update",i.update),i.update.stop(),e.refresh()})};Oe.prototype.calcShownTokenStart=function(){var e=this.cm,t=e.getCursor(),n=this.tokenTypes,i=new RegExp("\\sformatting-("+n.join("|")+")\\s"),r={},o=e.getLineTokens(t.line),a=-1,l=[],s=null,d=[];for(var c=0;c<o.length;c++){var h=o[c];-1===a&&(h.end>t.ch||c===o.length-1)&&(a=c);var f=h.type&&h.type.match(i);if(f){var u=f[1];if(u!==s){var m=l[l.length-1];if(m&&m[1]===u){if(l.pop(),-1!==a||h.end===t.ch){d.push(m[0],h);break}}else if(l.push([h,u]),-1!==a){d.push(h);var p=new RegExp("\\sformatting-"+u+"\\s");for(c+=1;c<o.length;c++){var v=o[c];if(v.type&&p.test(v.type)){d.push(v);break}}break}0,s=u}}else{if(-1!==a){if(0<l.length){var g=l.pop(),y=g[0],b=g[1],k=new RegExp("\\sformatting-"+b+"\\s");for(d.push(y),c+=1;c<o.length;c++){var T=o[c];if(T.type&&k.test(T.type)){d.push(T);break}}}break}s=null}if(-1!==a&&0===l.length)break}for(var x=r[t.line]=[],w=0,L=d;w<L.length;w+=1){var M=L[w];x.push(M.start)}if(c>=o.length-1)for(var D=0,_=l;D<_.length;D+=1){var H=_[D][0].start;-1===x.indexOf(H)&&x.push(H)}return r},Oe.prototype.procLine=function(e,t){if(!e)return-1;var n=this.cm,i=e.lineNo(),r=x(n,i);if(!r||r.hidden||!r.measure)return-1;for(var o=w(r,e,i).map,a=o.length/3,l=(i in this.shownTokensStart?this.shownTokensStart[i].slice().sort(function(e,t){return e-t}):null),s=-1,d=0,c=0;d<a;d++,c+=3){var h=o[c],f=(o[c+1],o[c+2]),u=f.parentElement;if(f.nodeType===Node.TEXT_NODE&&u&&/^span$/i.test(u.nodeName))for(var m=u.className,p=0,v=this.tokenTypes;p<v.length;p+=1){var g=v[p];if(("link"!==g||!/cm-hmd-footref|cm-hmd-footnote|cm-hmd-barelink/.test(m))&&-1!==m.indexOf("cm-formatting-"+g+" ")){var y=!0;if(l&&0<l.length){for(;l[0]<h;)l.shift();y=l[0]!==h}y?-1===m.indexOf(Se)&&(u.className+=" "+Se,-1===s&&(s=h)):-1!==m.indexOf(Se)&&(u.className=m.replace(Se,""),-1===s&&(s=h));break}}}if(this.line&&(t=t||r.text)){var b=t.className,k=-1===b.indexOf(Ce),T=null!==l;k!=T&&(t.className=T?b.replace(Ce,""):b+" "+Ce,s=0)}return-1!==s&&r.measure.cache&&(r.measure.cache={}),s},Oe.prototype.updateImmediately=function(){var r=this,o=this.cm,a=o.getCursor(),e=this.shownTokensStart,t=this.shownTokensStart=this.enabled?this.calcShownTokenStart():{},l=!1,s=[];for(var n in e)s.push(~~n);for(var i in t)s.push(~~i);s.sort(function(e,t){return e-t}),o.operation(function(){for(var e=-1,t=0,n=s;t<n.length;t+=1){var i=n[t];if(i!==e)e=i,-1!==r.procLine(o.getLineHandle(i))&&a.line===i&&(l=!0)}l&&(d(o,!0),o.hmd.tableAlign&&o.hmd.tableAlign.enabled&&o.hmd.tableAlign.updateStyle())})};var Ee=h("hideToken",Oe,He),Re=Object.freeze({defaultOption:He,HideToken:Oe,getAddon:Ee});S.defineOption("hmdCursorDebounce",!1,function(e,t){var n=!!t;Ne(e).ff_enable.setBool(n)});var Ae=function(e){var i=this;this.cm=e,this.mouseDownHandler=function(e,t){i.lastX=t.clientX,i.lastY=t.clientY;var n=i.mouseMoveSuppress;document.addEventListener("mousemove",n,!0),i.lastTimeout&&clearTimeout(i.lastTimeout),i.lastTimeout=setTimeout(function(){document.removeEventListener("mousemove",n,!0),i.lastTimeout=null},100)},this.mouseMoveSuppress=function(e){Math.abs(e.clientX-i.lastX)<=5&&Math.abs(e.clientY-i.lastY)<=5&&e.stopPropagation()},this.ff_enable=new s(function(){e.on("mousedown",i.mouseDownHandler)},function(){e.off("mousedown",i.mouseDownHandler)})},Ne=h("cursorDebounce",Ae),Ie=Object.freeze({CursorDebounce:Ae,getAddon:Ne}),Fe=/^(\s*)(>[> ]*|[*+-] \[[x ]\]\s|[*+-]\s|(\d+)([.)]))(\s*)/,je=/^(\s*)(>[> ]*|[*+-] \[[x ]\]|[*+-]|(\d+)[.)])(\s*)$/,Pe=/[*+-]\s/,$e=function(e){return/hmd-table-sep/.test(e.type)&&!/hmd-table-sep-dummy/.test(e.type)};function ze(e){if(e.getOption("disableInput"))return S.Pass;for(var t=[],n=0,i=e.listSelections();n<i.length;n+=1){var r=i[n],o=r.head,a=r.empty(),l=e.getStateAfter(o.line),s=e.getLine(o.line),d=!1;if(!d){var c=!1!==l.list,h=l.quote,f=Fe.exec(s),u=/^\s*$/.test(s.slice(0,o.ch));if(a&&(c||h)&&f&&!u)if(d=!0,je.test(s))/>\s*$/.test(s)||e.replaceRange("",{line:o.line,ch:0},{line:o.line,ch:o.ch+1}),t.push("\n");else{var m=f[1],p=f[5],v=!(Pe.test(f[2])||0<=f[2].indexOf(">")),g=v?parseInt(f[3],10)+1+f[4]:f[2].replace("x"," ");t.push("\n"+m+g+p),v&&Xe(e,o)}}if(!d){var y=a?l.hmdTable:0;if(0!=y){if(/^[\s\|]+$/.test(s)&&e.getStateAfter(o.line+1).hmdTable!==y)e.replaceRange("",{line:o.line,ch:0},{line:o.line,ch:s.length}),t.push("\n");else{for(var b=s.substr(o.ch),k="",T="",x=e.getTokenAt(o).state,w=0;w++<x.hmdTableCol;)k+=" | ";for(w--;w++<l.hmdTableCol;)T+=" | ";2===y&&(k=k.replace(/^\s+/,""),T=T.replace(/\s+$/,"")),1<b.length&&e.replaceRange(b.slice(1),{line:o.line,ch:o.ch+1},{line:o.line,ch:s.length}),t.push(T+"\n"+k)}d=!0}}if(!d)return void e.execCommand("newlineAndIndent")}e.replaceSelections(t)}function qe(e){if(e.getOption("disableInput"))return S.Pass;for(var t=e.listSelections(),n=a("\n",t.length),i=0;i<t.length;i++){var r=t[i].head,o=e.getStateAfter(r.line);!1!==o.list&&(n[i]+=u(" ",o.listStack.slice(-1)[0]))}e.replaceSelections(n)}function Be(e){for(var t=e.listSelections(),n=new M(e),i=0;i<t.length;i++){var r=t[i].head,o=e.getStateAfter(r.line);if(o.hmdTable&&2<=o.hmdTableRow){n.setPos(r.line,r.ch);var a,l=2===o.hmdTable,s=r.line,d=e.getLine(s),c=0,h=0,f=n.findPrev($e);if(f)c=(a=n.findPrev($e,f.i_token-1))?a.token.end:0,h=f.token.start,0==c&&l&&(c+=d.match(/^\s*\|/)[0].length);else s--,d=e.getLine(s),n.setPos(s,d.length),c=(a=n.findPrev($e)).token.end,h=d.length,l&&(h-=d.match(/\|\s*$/)[0].length);return 0<(c+=d.slice(c).match(/^\s*/)[0].length)&&" |"===d.substr(c-1,2)&&c--,h-=d.slice(c,h).match(/\s*$/)[0].length,void e.setSelection({line:s,ch:c},{line:s,ch:h})}}return S.Pass}function Ke(e){for(var t=e.listSelections(),n=new M(e),i=0;i<t.length;i++){var r=t[i],o=r.head,a=(r.empty(),e.getStateAfter(o.line)),l=e.getLine(o.line);if(a.hmdTable&&2<=a.hmdTableRow){var s=2===a.hmdTable;n.setPos(o.line,o.ch);var d=n.findNext($e,n.i_token),c=0,h=o.line;if(d)c=d.token.start+1;else c=0,h=o.line+1,e.getStateAfter(h).hmdTable?(l=e.getLine(h),s&&(c=l.indexOf("|")+1)):(l="",s&&(l+="| ",c+=2),l+=u(" | ",a.hmdTableCol-(s?2:0)),s&&(l+=" |"),e.replaceRange(l+"\n",{ch:0,line:h},{ch:0,line:h}));0<(c+=l.slice(c).match(/^\s*/)[0].length)&&" |"===l.substr(c-1,2)&&c--;var f=c+l.slice(c).match(/^\S*/)[0].length;return void e.setSelection({line:h,ch:c},{line:h,ch:f})}}e.execCommand("defaultTab")}function Ue(T,x,w){return function(e){var t;if(e.getOption("disableInput"))return S.Pass;for(var n=new M(e),i=e.listSelections(),r=new Array(i.length),o=0;o<i.length;o++){var a=i[o],l=a.head,s=a.anchor,d=e.getStateAfter(l.line);if(a.empty()){var c=l.line;n.setPos(c,l.ch,!0);var h=n.lineTokens[n.i_token];h&&h.state;r[o]="",h&&!/^\s*$/.test(h.string)||(h=n.lineTokens[--n.i_token]);var f=n.expandRange(function(e){return e&&(T(e.state)||x(e))}),u=f.from,m=f.to;if(m.i_token===u.i_token){var p=w();if(h&&!/^\s*$/.test(h.string)){var v={line:c,ch:h.start},g={line:c,ch:h.end};return h=u.token,e.replaceRange(p+h.string+p,v,g),g.ch+=p.length,void e.setCursor(g)}r[o]=p}else m.token.start===u.token.end?e.replaceRange("",{line:c,ch:u.token.start},{line:c,ch:m.token.end}):(x(m.token)&&e.replaceRange("",{line:c,ch:m.token.start},{line:c,ch:m.token.end}),x(u.token)&&e.replaceRange("",{line:c,ch:u.token.start},{line:c,ch:u.token.end}))}else{0<L.cmpPos(l,s)&&(s=(t=[l,s])[0],l=t[1]);var y=e.getTokenAt(l),b=y?y.state:d,k=w(b);r[o]=k+e.getRange(l,s)+k}}e.replaceSelections(r)}}function Xe(e,t){var n=Fe,i=t.line,r=0,o=0,a=n.exec(e.getLine(i)),l=a[1];do{var s=i+(r+=1),d=e.getLine(s),c=n.exec(d);if(c){var h=c[1],f=parseInt(a[3],10)+r-o,u=parseInt(c[3],10),m=u;if(l!==h||isNaN(u)){if(l.length>h.length)return;if(l.length<h.length&&1===r)return;o+=1}else f===u&&(m=u+1),u<f&&(m=f+1),e.replaceRange(d.replace(n,h+m+c[4]+c[5]),{line:s,ch:0},{line:s,ch:d.length})}}while(c)}Object.assign(S.commands,{hmdNewlineAndContinue:ze,hmdNewline:qe,hmdShiftTab:Be,hmdTab:Ke});S.keyMap.default;var Je={"Shift-Tab":"hmdShiftTab",Tab:"hmdTab",Enter:"hmdNewlineAndContinue","Shift-Enter":"hmdNewline","Ctrl-B":Ue(function(e){return e.strong},function(e){return/ formatting-strong /.test(e.type)},function(e){return u(e&&e.strong||"*",2)}),"Ctrl-I":Ue(function(e){return e.em},function(e){return/ formatting-em /.test(e.type)},function(e){return e&&e.em||"*"}),"Ctrl-D":Ue(function(e){return e.strikethrough},function(e){return/ formatting-strikethrough /.test(e.type)},function(e){return"~~"}),fallthrough:"default"};Je=S.normalizeKeyMap(Je),S.keyMap.hypermd=Je;var Ye=Object.freeze({newlineAndContinue:ze,newline:qe,shiftTab:Be,tab:Ke,createStyleToggler:Ue,get keyMap(){return Je}});e.InsertFile=T,e.ReadLink=$,e.Hover=X,e.Click=ee,e.Paste=oe,e.Fold=ue,e.FoldMath=ke,e.TableAlign=Le,e.ModeLoader=_e,e.HideToken=Re,e.CursorDebounce=Ie,e.KeyMap=Ye,e.Addon=m,e.FlipFlop=s,e.tryToRun=c,e.debounce=r,e.repeat=a,e.repeatStr=u,e.fromTextArea=function(e,t){var n={lineNumbers:!0,lineWrapping:!0,theme:"hypermd-light",mode:"text/x-hypermd",tabSize:4,foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter","HyperMD-goback"],keyMap:"hypermd"in S.keyMap?"hypermd":"default",hmdInsertFile:{byDrop:!0,byPaste:!0},hmdCursorDebounce:!0,hmdHover:!0,hmdClick:!0,hmdFold:{image:!0,link:!0,math:!0},hmdFoldMath:{},hmdPaste:!0,hmdHideToken:!0,hmdLoadModeFrom:"~codemirror/",hmdTableAlign:!0};if("object"==typeof t)for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i]);return S.fromTextArea(e,n)},e.switchToNormal=function(e,t){e.setOption("theme",t||"default"),e.setOption("hmdFold",!1),e.setOption("hmdHideToken",!1),e.setOption("hmdTableAlign",!1)},e.switchToHyperMD=function(e,t){e.setOption("theme",t||"hypermd-light"),e.setOption("hmdFold",!0),e.setOption("hmdHideToken",!0),e.setOption("hmdTableAlign",!0)},e.cm_internal=l,e.TokenSeeker=M,e.getEveryCharToken=function(e){var t=new Array(e.text.length),n=e.styles,i=0;if(n)for(var r=1;r<n.length;r+=2)for(var o=n[r],a=n[r+1];i<o;)t[i++]=a;else for(var l=(e.parent.cm||e.parent.parent.cm||e.parent.parent.parent.cm).getLineTokens(e.lineNo()),s=0;s<l.length;s++)for(var d=l[s].end,c=l[s].type;i<d;)t[i++]=c;return t},e.expandRange=b,e.updateCursorDisplay=d,Object.defineProperty(e,"__esModule",{value:!0})});
